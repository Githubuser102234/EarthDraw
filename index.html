<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Drawing Map</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        #map-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 120px);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
        }

        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: all 0.2s;
        }

        .leaflet-container {
            background-color: transparent !important;
        }

        .control-panel {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tool-button, .action-button, .mode-button {
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .tool-button.active {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
            transform: scale(0.98);
        }

        #user-info img {
            border-radius: 9999px;
            width: 32px;
            height: 32px;
        }

        #drawings-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100vh;
            background-color: #ffffff;
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            overflow-y: auto;
        }

        #drawings-menu.open {
            transform: translateX(0);
        }

        #menu-toggle-btn {
            position: fixed;
            top: 1.5rem;
            left: 1rem;
            z-index: 2001;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">

    <!-- Main Content -->
    <div class="max-w-4xl w-full mx-auto">
        <header class="text-center my-4">
            <h1 class="text-3xl font-bold text-gray-800">Interactive Drawing Map</h1>
            <p class="text-gray-600 mt-2">Draw, save, and share your creations on the map.</p>
        </header>

        <!-- Login and App UI -->
        <div id="auth-container" class="flex flex-col items-center justify-center bg-white p-8 rounded-xl shadow-lg transition-all duration-300">
            <p id="loading-message" class="text-lg text-gray-700 font-semibold mb-4">Loading application...</p>
            <p id="auth-message" class="text-lg text-gray-700 font-semibold mb-4 hidden">Please sign in to start drawing.</p>
            <button id="google-signin-button" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full flex items-center space-x-2 hover:bg-blue-600 transition-colors hidden">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21.002 10.25c.071.536.113 1.077.113 1.625 0 2.214-.658 4.288-1.928 5.864l-1.42-1.27c.805-1.047 1.272-2.39 1.272-3.662 0-.306-.027-.61-.077-.912H12.002v3.468h4.591c-.247 1.133-.873 2.112-1.803 2.766l1.247 1.054c1.174-.89 2.072-2.222 2.585-3.792C20.67 15.65 21.002 13.987 21.002 12.25c0-.668-.094-1.32-.236-1.932zM12.002 21.996c2.973 0 5.485-1.01 7.245-2.735l-1.247-1.054c-1.096.827-2.5 1.34-3.998 1.34-3.486 0-6.44-2.316-7.49-5.467h-3.94l-.001.001 1.487 3.655C6.44 19.845 8.956 21.996 12.002 21.996zM4.53 13.99c-.198-.53-.306-1.1-.306-1.69s.108-1.16.306-1.69L3.045 7.64c-.456.966-.715 2.064-.715 3.25s.259 2.284.715 3.25l1.485 3.65zM12.002 5.04c2.083 0 3.966.85 5.295 2.24l-1.745 1.54c-.933-.89-2.164-1.432-3.55-1.432-1.066 0-2.052.282-2.898.795l-1.474-3.66c1.238-.97 2.744-1.583 4.417-1.583z"/>
                </svg>
                <span>Sign In with Google</span>
            </button>
        </div>

        <div id="main-app" class="hidden">
            <div id="map-container">
                <div id="map"></div>
                <canvas id="drawing-canvas"></canvas>
            </div>

            <div class="control-panel flex flex-col md:flex-row items-center justify-between mt-4 space-y-4 md:space-y-0 md:space-x-4">
                <!-- Drawing Tools -->
                <div id="drawing-tools" class="flex items-center space-x-2">
                    <button id="draw-tool" class="tool-button bg-blue-500 text-white hover:bg-blue-600 active">Draw</button>
                    <input type="color" id="color-picker" class="w-10 h-10 p-1 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-2">
                    <button id="toggle-mode-button" class="mode-button bg-gray-500 text-white hover:bg-gray-600">Toggle View Mode</button>
                    <button id="clear-button" class="action-button bg-red-500 text-white hover:bg-red-600">Clear</button>
                    <button id="save-button" class="action-button bg-green-500 text-white hover:bg-green-600">Save Drawing</button>
                </div>
            </div>

            <!-- User Info and Status -->
            <div class="bg-white p-4 rounded-xl mt-4 text-sm text-gray-700 shadow-lg flex items-center justify-between">
                <div id="user-info" class="flex items-center space-x-2">
                    <img id="user-photo" class="rounded-full" src="" alt="User Photo" onerror="this.src='https://placehold.co/32x32/E5E7EB/4B5563?text=user'">
                    <span id="user-name" class="font-semibold text-gray-800"></span>
                </div>
                <button id="sign-out-button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold hover:bg-gray-300 transition-colors">Sign Out</button>
            </div>
            <div class="bg-white p-4 rounded-xl mt-2 text-sm text-gray-700 shadow-lg">
                <p id="status-message" class="font-semibold"></p>
                <p class="mt-2">Your User ID: <span id="user-id" class="font-mono bg-gray-200 px-2 py-1 rounded">Loading...</span></p>
            </div>
        </div>
    </div>
    
    <!-- Menu Toggle Button -->
    <button id="menu-toggle-btn" class="bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Side Menu for Drawings -->
    <div id="drawings-menu">
        <h2 class="text-xl font-bold mb-4">Your Drawings</h2>
        <ul id="drawings-list" class="space-y-2">
            <!-- Drawings will be injected here -->
        </ul>
    </div>
    
    <!-- Modal for Saving Drawing Name -->
    <div id="save-drawing-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold">Name Your Drawing</h3>
            <input type="text" id="drawing-name-input" placeholder="Enter drawing name..." class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex space-x-2 justify-end">
                <button id="save-drawing-modal-cancel" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="save-drawing-modal-save" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal for Deleting Drawing Confirmation -->
    <div id="delete-drawing-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold">Confirm Deletion</h3>
            <p>Are you sure you want to delete this drawing? This action cannot be undone.</p>
            <div class="flex space-x-2 justify-end">
                <button id="delete-drawing-modal-cancel" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="delete-drawing-modal-confirm" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Firebase JS (using the older, stable version 11.6.1) -->
    <script type="module">
        // Import all necessary Firebase SDKs with the correct version
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, collection, onSnapshot, query, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging Firestore issues
        setLogLevel('debug');

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDn8MsNDYmDs27KCQqAmpAXo5zgGUv4Sjk",
            authDomain: "earthdraw-33c87.firebaseapp.com",
            projectId: "earthdraw-33c87",
            storageBucket: "earthdraw-33c87.firebasestorage.app",
            messagingSenderId: "203683394694",
            appId: "1:203683394694:web:95bec4420988a52c2b8d07",
            measurementId: "G-26GXSJGJSP"
        };
        const appId = firebaseConfig.projectId;

        // --- UI Element References ---
        const statusMessageEl = document.getElementById('status-message');
        const userIdEl = document.getElementById('user-id');
        const authContainer = document.getElementById('auth-container');
        const mainApp = document.getElementById('main-app');
        const googleSignInButton = document.getElementById('google-signin-button');
        const signOutButton = document.getElementById('sign-out-button');
        const userNameEl = document.getElementById('user-name');
        const userPhotoEl = document.getElementById('user-photo');
        const loadingMessageEl = document.getElementById('loading-message');
        const authMessageEl = document.getElementById('auth-message');

        let db, auth, userId;
        let allDrawings = [];
        let drawingToDeleteId = null;

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Set up the listener first, then attempt to sign in.
                setupAuthListeners();
                await setupInitialAuth();
            } catch (error) {
                loadingMessageEl.classList.add('hidden');
                statusMessageEl.textContent = `Firebase init failed: ${error.message}`;
                console.error("Firebase init failed:", error);
            }
        };
        
        const setupInitialAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined') {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("Custom token sign-in failed, falling back to anonymous:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        };

        const setupAuthListeners = () => {
            onAuthStateChanged(auth, (user) => {
                loadingMessageEl.classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    userIdEl.textContent = userId;
                    userNameEl.textContent = user.displayName || 'Anonymous User';
                    userPhotoEl.src = user.photoURL || 'https://placehold.co/32x32/E5E7EB/4B5563?text=user';
                    authContainer.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    statusMessageEl.textContent = 'Signed in successfully. Happy drawing!';
                    loadDrawings();
                } else {
                    userId = null;
                    authContainer.classList.remove('hidden');
                    authMessageEl.classList.remove('hidden');
                    googleSignInButton.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    statusMessageEl.textContent = 'Please sign in to continue.';
                }
            });
        };

        googleSignInButton.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                statusMessageEl.textContent = `Sign-in failed: ${error.message}`;
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                statusMessageEl.textContent = 'Signed out.';
            } catch (error) {
                console.error("Sign-out failed:", error);
                statusMessageEl.textContent = `Sign-out failed: ${error.message}`;
            }
        });

        // --- Map Initialization ---
        const map = L.map('map').setView([40.7128, -74.0060], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const drawingToolsEl = document.getElementById('drawing-tools');
        let isDrawingMode = true;
        let isDrawing = false;
        let points = [];
        let color = '#3b82f6';

        const resizeCanvas = () => {
            const mapContainer = document.getElementById('map-container');
            canvas.width = mapContainer.clientWidth;
            canvas.height = mapContainer.clientHeight;
            // Redraw all drawings on canvas resize to maintain position relative to map
            redrawAllDrawings();
        };
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // --- Drawing and Viewing Logic ---
        const getPoint = (event) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        };

        const startDrawing = (event) => {
            if (!isDrawingMode || !userId) return;
            event.preventDefault();
            isDrawing = true;
            points = [];
            const point = getPoint(event);
            const latLng = map.containerPointToLatLng([point.x, point.y]);
            points.push({ lat: latLng.lat, lng: latLng.lng });
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(point.x, point.y);
        };

        const draw = (event) => {
            if (!isDrawing || !isDrawingMode) return;
            const point = getPoint(event);
            const latLng = map.containerPointToLatLng([point.x, point.y]);
            points.push({ lat: latLng.lat, lng: latLng.lng });
            ctx.lineTo(point.x, point.y);
            ctx.stroke();
        };

        const endDrawing = () => {
            if (!isDrawing) return;
            isDrawing = false;
            ctx.closePath();
            if (points.length < 5) {
                clearLocalCanvas();
                return;
            }
        };

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mouseup', endDrawing);
        canvas.addEventListener('mouseout', endDrawing);
        canvas.addEventListener('mousemove', draw);

        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchend', endDrawing);
        canvas.addEventListener('touchcancel', endDrawing);
        canvas.addEventListener('touchmove', draw);

        // --- UI Element Event Listeners ---
        document.getElementById('color-picker').addEventListener('input', (e) => {
            color = e.target.value;
        });

        document.getElementById('clear-button').addEventListener('click', () => {
            clearLocalCanvas();
            statusMessageEl.textContent = 'Canvas cleared.';
        });

        document.getElementById('save-button').addEventListener('click', () => {
            if (points.length === 0) {
                statusMessageEl.textContent = 'Draw something before saving!';
                return;
            }
            if (!userId) {
                statusMessageEl.textContent = 'You must be signed in to save.';
                return;
            }
            document.getElementById('save-drawing-modal').classList.remove('hidden');
        });

        document.getElementById('save-drawing-modal-cancel').addEventListener('click', () => {
            document.getElementById('save-drawing-modal').classList.add('hidden');
        });

        document.getElementById('save-drawing-modal-save').addEventListener('click', async () => {
            const drawingNameInput = document.getElementById('drawing-name-input');
            const drawingName = drawingNameInput.value.trim();
            if (!drawingName) {
                statusMessageEl.textContent = 'Please enter a name for your drawing.';
                return;
            }
            document.getElementById('save-drawing-modal').classList.add('hidden');
            statusMessageEl.textContent = 'Saving drawing...';
            const drawingData = {
                name: drawingName,
                points: JSON.stringify(points),
                color: color,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/drawings`), drawingData);
                statusMessageEl.textContent = 'Drawing saved successfully!';
                clearLocalCanvas();
                drawingNameInput.value = ''; // Clear input field
            } catch (e) {
                console.error("Error saving document: ", e);
                statusMessageEl.textContent = 'Error saving drawing. See console for details.';
            }
        });

        document.getElementById('toggle-mode-button').addEventListener('click', () => {
            isDrawingMode = !isDrawingMode;
            if (isDrawingMode) {
                drawingToolsEl.classList.remove('hidden');
                document.getElementById('toggle-mode-button').textContent = 'Toggle View Mode';
                statusMessageEl.textContent = 'Drawing mode enabled. You can now draw on the map.';
                canvas.style.pointerEvents = 'auto'; // Re-enable pointer events on the canvas
            } else {
                drawingToolsEl.classList.add('hidden');
                document.getElementById('toggle-mode-button').textContent = 'Toggle Draw Mode';
                statusMessageEl.textContent = 'Viewing mode enabled. Pan and zoom freely.';
                canvas.style.pointerEvents = 'none'; // Disable pointer events on the canvas
            }
        });

        document.getElementById('menu-toggle-btn').addEventListener('click', () => {
            document.getElementById('drawings-menu').classList.toggle('open');
        });
        
        const goToDrawing = (drawingId) => {
            const drawing = allDrawings.find(d => d.id === drawingId);
            if (!drawing) return;

            const drawingPoints = JSON.parse(drawing.points);
            if (drawingPoints.length === 0) return;

            // Calculate the center of the drawing
            const latSum = drawingPoints.reduce((sum, p) => sum + p.lat, 0);
            const lngSum = drawingPoints.reduce((sum, p) => sum + p.lng, 0);
            const centerLat = latSum / drawingPoints.length;
            const centerLng = lngSum / drawingPoints.length;

            map.flyTo([centerLat, centerLng], 15, { duration: 1.5 });
            document.getElementById('drawings-menu').classList.remove('open');
            statusMessageEl.textContent = `Mapsd to drawing: ${drawing.name}`;
        };

        const deleteDrawing = async () => {
            if (!drawingToDeleteId) return;

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/drawings`, drawingToDeleteId));
                statusMessageEl.textContent = 'Drawing deleted successfully!';
            } catch (e) {
                console.error("Error deleting document: ", e);
                statusMessageEl.textContent = 'Error deleting drawing. See console for details.';
            } finally {
                drawingToDeleteId = null;
                document.getElementById('delete-drawing-modal').classList.add('hidden');
            }
        };
        
        document.getElementById('delete-drawing-modal-confirm').addEventListener('click', deleteDrawing);
        document.getElementById('delete-drawing-modal-cancel').addEventListener('click', () => {
            drawingToDeleteId = null;
            document.getElementById('delete-drawing-modal').classList.add('hidden');
        });

        // --- Canvas and Firestore Sync ---
        const clearLocalCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            points = [];
        };
        
        const redrawAllDrawings = () => {
            clearLocalCanvas();
            allDrawings.forEach(drawing => renderDrawing(drawing));
        };

        const renderDrawing = (drawing) => {
            try {
                const drawingPoints = JSON.parse(drawing.points);
                if (drawingPoints.length === 0) return;
                ctx.strokeStyle = drawing.color;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                const startPoint = map.latLngToContainerPoint([drawingPoints[0].lat, drawingPoints[0].lng]);
                ctx.moveTo(startPoint.x, startPoint.y);

                for (let i = 1; i < drawingPoints.length; i++) {
                    const nextPoint = map.latLngToContainerPoint([drawingPoints[i].lat, drawingPoints[i].lng]);
                    ctx.lineTo(nextPoint.x, nextPoint.y);
                }
                ctx.stroke();
            } catch (e) {
                console.error("Error rendering drawing: ", e);
            }
        };

        const renderDrawingsList = () => {
            const drawingsListEl = document.getElementById('drawings-list');
            drawingsListEl.innerHTML = '';
            if (allDrawings.length === 0) {
                drawingsListEl.innerHTML = '<p class="text-gray-500 text-sm">No drawings found. Start drawing and save your first one!</p>';
                return;
            }

            allDrawings.forEach(drawing => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-100 transition-colors cursor-pointer';
                li.innerHTML = `
                    <div class="flex items-center space-x-2 w-full" data-drawing-id="${drawing.id}">
                        <i class="fas fa-map-pin text-gray-400"></i>
                        <span class="text-sm font-medium text-gray-700 truncate">${drawing.name}</span>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 p-1 rounded" data-delete-id="${drawing.id}" title="Delete Drawing">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                li.querySelector('div').addEventListener('click', (e) => {
                    goToDrawing(e.currentTarget.dataset.drawingId);
                });
                li.querySelector('button').addEventListener('click', (e) => {
                    drawingToDeleteId = e.currentTarget.dataset.deleteId;
                    document.getElementById('delete-drawing-modal').classList.remove('hidden');
                    e.stopPropagation(); // Prevent the parent 'go to' event from firing
                });
                drawingsListEl.appendChild(li);
            });
        };

        const loadDrawings = () => {
            if (!db || !userId) {
                statusMessageEl.textContent = 'Waiting for user authentication...';
                return;
            }

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/drawings`));
            onSnapshot(q, (querySnapshot) => {
                // Update local array with new data
                allDrawings = [];
                querySnapshot.forEach((doc) => {
                    allDrawings.push({ id: doc.id, ...doc.data() });
                });
                
                // Redraw canvas with all current drawings
                redrawAllDrawings();
                // Re-render the side menu
                renderDrawingsList();
                
            }, (error) => {
                console.error("Error getting documents:", error);
                statusMessageEl.textContent = 'Error fetching drawings from Firestore.';
            });
        };

        // Redraw drawings on map pan/zoom
        map.on('moveend', () => {
            if (userId) {
                redrawAllDrawings();
            }
        });

        // --- Start App ---
        window.onload = initFirebase;
    </script>
</body>
</html>
